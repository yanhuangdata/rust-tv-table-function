name: Sync Release to JihuLab

on:
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'è¦åŒæ­¥çš„ Release Tag (ä¾‹å¦‚: v1.0.0)ã€‚ç•™ç©ºåˆ™åŒæ­¥æœ€æ–°çš„ Releaseã€‚'
        required: false
        default: ''
      force_overwrite:
        description: 'å¦‚æœæç‹GitLabä¸Šå·²å­˜åœ¨åŒå Releaseï¼Œæ˜¯å¦å¼ºåˆ¶è¦†ç›–ã€‚'
        required: false
        default: false
        type: boolean

jobs:
  sync-to-jihulab:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine release information
        id: release_info
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # --- æ‰‹åŠ¨è§¦å‘ ---
            if [[ -n "${{ github.event.inputs.tag_name }}" ]]; then
              TAG_NAME="${{ github.event.inputs.tag_name }}"
              echo "Using specified tag from manual dispatch: $TAG_NAME"
            else
              echo "No tag specified, fetching the latest release from GitHub API..."
              LATEST_RELEASE_DATA=$(curl -s -f -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/releases/latest")
              if [ $? -ne 0 ]; then
                echo "::error::Failed to fetch latest release from GitHub."
                exit 1
              fi
              TAG_NAME=$(echo "$LATEST_RELEASE_DATA" | jq -r '.tag_name')
              echo "Using latest release tag: $TAG_NAME"
            fi
            FORCE_OVERWRITE="${{ github.event.inputs.force_overwrite }}"
          else
            # --- Release äº‹ä»¶è‡ªåŠ¨è§¦å‘ ---
            TAG_NAME="${{ github.event.release.tag_name }}"
            FORCE_OVERWRITE="false" # è‡ªåŠ¨è§¦å‘æ—¶ï¼Œé»˜è®¤ä¸è¦†ç›–
            echo "Using tag from release event: $TAG_NAME"
          fi
          
          # å°†ç»“æœè¾“å‡ºç»™åç»­æ­¥éª¤ä½¿ç”¨
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "force_overwrite=$FORCE_OVERWRITE" >> $GITHUB_OUTPUT
          echo "Selected Tag: $TAG_NAME, Force Overwrite: $FORCE_OVERWRITE"

      - name: Get GitHub release data
        id: release_data
        run: |
          TAG_NAME="${{ steps.release_info.outputs.tag_name }}"
          echo "Fetching release data for tag: $TAG_NAME"
          
          RELEASE_DATA=$(curl -s -f -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG_NAME")
          
          if [ $? -ne 0 ]; then
            echo "::error::Release with tag '$TAG_NAME' not found on GitHub."
            exit 1
          fi
          
          # æå– Release åç§°, æè¿°å’Œ assets çš„ä¸‹è½½é“¾æ¥
          RELEASE_NAME=$(echo "$RELEASE_DATA" | jq -r '.name')
          RELEASE_BODY=$(echo "$RELEASE_DATA" | jq -r '.body')
          ASSET_URLS=$(echo "$RELEASE_DATA" | jq -r '.assets[].browser_download_url')
          
          # æ­£ç¡®å¤„ç†å¤šè¡Œå­—ç¬¦ä¸²è¾“å‡º
          # ä½¿ç”¨ç‰¹æ®Šçš„åˆ†éš”ç¬¦æ¥å­˜å‚¨å¤šè¡Œå†…å®¹
          {
            echo "release_name=$RELEASE_NAME"
            echo 'release_body<<EOF'
            echo "$RELEASE_BODY"
            echo 'EOF'
            echo 'asset_urls<<EOF'
            echo "$ASSET_URLS"
            echo 'EOF'
          } >> $GITHUB_OUTPUT
          
          echo "Release Name: $RELEASE_NAME"
          echo "Assets to download:"
          echo "$ASSET_URLS"

      # æ­¥éª¤ 4: ä¸‹è½½æ‰€æœ‰ Release assets
      - name: Download release assets
        run: |
          mkdir -p assets
          echo "${{ steps.release_data.outputs.asset_urls }}" | while read url; do
            if [[ -n "$url" ]]; then
              filename=$(basename "$url")
              echo "Downloading $filename..."
              curl -L -o "assets/$filename" "$url"
            fi
          done
          
          echo "Downloaded files:"
          ls -la assets/ || echo "No assets were downloaded."

      # æ­¥éª¤ 5: æ£€æŸ¥æç‹GitLabä¸Šæ˜¯å¦å·²å­˜åœ¨è¯¥ Release
      - name: Check if JihuLab release exists
        id: check_jihulab_release
        run: |
          TAG_NAME="${{ steps.release_info.outputs.tag_name }}"
          
          echo "Checking if release $TAG_NAME exists in JihuLab..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "PRIVATE-TOKEN: ${{ secrets.JIHULAB_TOKEN }}" \
            "https://jihulab.com/api/v4/projects/${{ secrets.JIHULAB_PROJECT_ID }}/releases/$TAG_NAME")
          
          echo "JihuLab API returned HTTP status: $HTTP_STATUS"
          
          if [[ "$HTTP_STATUS" == "200" ]]; then
            echo "Release '$TAG_NAME' already exists in JihuLab."
            if [[ "${{ steps.release_info.outputs.force_overwrite }}" == "true" ]]; then
              echo "Force overwrite is enabled. The existing release will be deleted and recreated."
              echo "should_run=true" >> $GITHUB_OUTPUT
              echo "should_delete=true" >> $GITHUB_OUTPUT
            else
              echo "Skipping sync because the release already exists and force_overwrite is false."
              echo "should_run=false" >> $GITHUB_OUTPUT
              echo "should_delete=false" >> $GITHUB_OUTPUT
            fi
          elif [[ "$HTTP_STATUS" == "404" ]]; then
            echo "Release '$TAG_NAME' does not exist in JihuLab. A new one will be created."
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "should_delete=false" >> $GITHUB_OUTPUT
          else
            echo "::error::Failed to check JihuLab release. API returned HTTP status $HTTP_STATUS."
            exit 1
          fi

      # æ­¥éª¤ 6: å¦‚æœéœ€è¦ï¼Œåˆ é™¤å·²å­˜åœ¨çš„æç‹GitLab Release
      - name: Delete existing JihuLab release
        if: steps.check_jihulab_release.outputs.should_delete == 'true'
        run: |
          TAG_NAME="${{ steps.release_info.outputs.tag_name }}"
          echo "Deleting existing release $TAG_NAME from JihuLab..."
          
          curl -X DELETE -f -s \
            -H "PRIVATE-TOKEN: ${{ secrets.JIHULAB_TOKEN }}" \
            "https://jihulab.com/api/v4/projects/${{ secrets.JIHULAB_PROJECT_ID }}/releases/$TAG_NAME"
          
          if [ $? -ne 0 ]; then
              echo "::warning::Failed to delete existing release. This might cause the next step to fail if the tag is still locked."
          else
              echo "Existing release deleted successfully."
          fi
          echo "Waiting for 3 seconds for cleanup..."
          sleep 3

      # æ­¥éª¤ 7: ä¸Šä¼  Assets å¹¶åˆ›å»º/æ›´æ–° JihuLab Release
      - name: Create JihuLab Release and Upload Assets
        if: steps.check_jihulab_release.outputs.should_run == 'true'
        run: |
          TAG_NAME="${{ steps.release_info.outputs.tag_name }}"
          RELEASE_NAME="${{ steps.release_data.outputs.release_name }}"
          RELEASE_BODY="${{ steps.release_data.outputs.release_body }}"
          
          # --- ä¸Šä¼ æ‰€æœ‰ assets å¹¶æ”¶é›†é“¾æ¥ä¿¡æ¯ ---
          echo "Uploading assets to JihuLab project..."
          ASSET_LINKS_JSON=""
          for file in assets/*; do
            if [[ -f "$file" ]]; then
              filename=$(basename "$file")
              echo "Uploading: $filename"
          
              UPLOAD_RESPONSE=$(curl -X POST -f -s \
                -H "PRIVATE-TOKEN: ${{ secrets.JIHULAB_TOKEN }}" \
                -F "file=@$file" \
                "https://jihulab.com/api/v4/projects/${{ secrets.JIHULAB_PROJECT_ID }}/uploads")
          
              if [ $? -ne 0 ]; then
                  echo "::error::Failed to upload asset '$filename'."
                  exit 1
              fi
          
              echo "Upload response for $filename:"
              echo "$UPLOAD_RESPONSE" | jq .
          
              # ä»å“åº”ä¸­æå–ä¿¡æ¯å¹¶æ„å»º assets.links çš„ JSON å¯¹è±¡
              FILE_URL=$(echo "$UPLOAD_RESPONSE" | jq -r '.url')
              LINK_JSON=$(jq -n \
                --arg name "$filename" \
                --arg url "https://jihulab.com/${{ secrets.JIHULAB_PROJECT_PATH }}${FILE_URL}" \
                '{name: $name, url: $url, link_type: "other"}')
          
              ASSET_LINKS_JSON="${ASSET_LINKS_JSON}${LINK_JSON},"
            fi
          done
          
          ASSET_LINKS_JSON="[${ASSET_LINKS_JSON%,}]"
          echo "Constructed Asset Links JSON: $ASSET_LINKS_JSON"
          
          # --- åˆ›å»º Release å¹¶é™„å¸¦ Assets ---
          echo "Creating JihuLab release: $TAG_NAME"
          
          # å‡†å¤‡åˆ›å»º Release çš„ JSON payload
          # å°† assets.links ç›´æ¥åŒ…å«åœ¨å†…
          RELEASE_PAYLOAD=$(jq -n \
            --arg tag "$TAG_NAME" \
            --arg name "$RELEASE_NAME" \
            --arg description "$RELEASE_BODY" \
            --argjson assets_links "$ASSET_LINKS_JSON" \
            '{
              tag_name: $tag,
              name: $name,
              description: $description,
              assets: {
                links: $assets_links
              }
            }')
          
          echo "Release creation payload:"
          echo "$RELEASE_PAYLOAD" | jq .
          
          # å‘é€åˆ›å»º Release çš„è¯·æ±‚
          CREATE_RESPONSE=$(curl -X POST -f -s \
            -H "PRIVATE-TOKEN: ${{ secrets.JIHULAB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "$RELEASE_PAYLOAD" \
            "https://jihulab.com/api/v4/projects/${{ secrets.JIHULAB_PROJECT_ID }}/releases")
          
          if [ $? -ne 0 ]; then
              echo "::error::Failed to create JihuLab release. The API call failed."
              # å°è¯•è¾“å‡º API è¿”å›çš„é”™è¯¯ä¿¡æ¯
              curl -X POST -s \
                -H "PRIVATE-TOKEN: ${{ secrets.JIHULAB_TOKEN }}" \
                -H "Content-Type: application/json" \
                -d "$RELEASE_PAYLOAD" \
                "https://jihulab.com/api/v4/projects/${{ secrets.JIHULAB_PROJECT_ID }}/releases" | jq .
              exit 1
          fi
          
          echo "âœ… JihuLab release created successfully!"
          echo "Response:"
          echo "$CREATE_RESPONSE" | jq .

      # æ­¥éª¤ 8: è¾“å‡ºæ€»ç»“ä¿¡æ¯
      - name: Final Summary
        if: always() # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
        run: |
          echo "## ğŸ“‹ Sync to JihuLab Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag**: ${{ steps.release_info.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.check_jihulab_release.outputs.should_run }}" == "true" ]]; then
            echo "- **Status**: âœ… **Success**" >> $GITHUB_STEP_SUMMARY
            echo "- **JihuLab Release URL**: https://jihulab.com/${{ secrets.JIHULAB_PROJECT_PATH }}/-/releases/${{ steps.release_info.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ job.status }}" == "success" ]]; then
            echo "- **Status**: â­ï¸ **Skipped**" >> $GITHUB_STEP_SUMMARY
            echo "- **Reason**: Release already exists in JihuLab and 'force_overwrite' was not enabled." >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: âŒ **Failed**" >> $GITHUB_STEP_SUMMARY
            echo "- **Reason**: The workflow encountered an error. Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
